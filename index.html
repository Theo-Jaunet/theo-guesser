<!DOCTYPE html>
<html lang="en">
<head>

    <!-- Basic Page Needs
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <meta charset="utf-8">
    <title>Projection</title>
    <meta name="description" content="">
    <meta name="author" content="Theo Jaunet, Romain Vuillemot, and Christian Wolf">
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <!-- Mobile Specific Metas
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- FONT
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <link href="//fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">

    <!-- CSS
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <link rel="stylesheet" href="assets/css/normalize.css">
    <link rel="stylesheet" href="assets/css/skeleton.css">

    <!-- Favicon
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <link rel="icon" type="image/png" href="assets/images/favicon/favicon.ico">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
            integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="assets/js/projector.js"></script>
    <script src="assets/js/local.js"></script>
    <style>
        path {

            opacity: 0.8;
        }

        .play:hover {

            cursor: pointer;
            transform: scale(1.1);
        }


        input::-moz-focus-inner {
            border: 0;
        }

        input[type=range]::-moz-focus-outer {
            border: 0;
        }

        input[type="range"] {
            -webkit-appearance: none;
            -moz-apperance: none;
            border-radius: 6px;
            height: 6px;
            user-select: none;
            outline: none;
            width: 100%;
            border: 0;
            background-image: -webkit-gradient(
                    linear,
                    left top,
                    right top,
                    color-stop(0, #233E34),
                    color-stop(0, #C5C5C5)
            );
            -webkit-touch-callout: none; /* iOS Safari */
            -webkit-user-select: none; /* Safari */
            -khtml-user-select: none; /* Konqueror HTML */
            -moz-user-select: none; /* Firefox */
            -ms-user-select: none; /* Internet Explorer/Edge */
            user-select: none;
            user-focus: none;
            /* Non-prefixed version, currently
                                             supported by Chrome and Opera */
        }

        input[type='range']::-webkit-slider-thumb {
            -webkit-appearance: none !important;
            background-color: #183d4e;
            border: 1px solid #183d4e;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            -webkit-touch-callout: none; /* iOS Safari */
            -webkit-user-select: none; /* Safari */
            -khtml-user-select: none; /* Konqueror HTML */
            -moz-user-select: none; /* Firefox */
            -ms-user-select: none; /* Internet Explorer/Edge */
            user-select: none;
            cursor: pointer;
        }

        input[type='range']::-moz-range-thumb {
            -webkit-appearance: none !important;
            background-color: #183d4e;
            border: 1px solid #183d4e;
            height: 18px;
            width: 18px;
            opacity: 1;
            border-radius: 50%;
            -webkit-touch-callout: none; /* iOS Safari */
            -webkit-user-select: none; /* Safari */
            -khtml-user-select: none; /* Konqueror HTML */
            -moz-user-select: none; /* Firefox */
            -ms-user-select: none; /* Internet Explorer/Edge */
            user-select: none;
            cursor: pointer;
        }
    </style>
</head>
<body>

<!-- Primary Page Layout
–––––––––––––––––––––––––––––––––––––––––––––––––– -->
<div class="container" style="margin-bottom: 5%; width: 1100px;max-width: 1100px">
    <div class="row">
        <div class="twelve column" style="margin-top: 10%">
            <h4 style="text-align: center"> VisXAi2 </h4>
        </div>
    </div>


    <div class="row">
        <div class="twelve column" style="margin-top: 10%">
            <h4 style="text-align: left"> Introduction </h4>
            <p>
                The last years have witnessed the soaring of Machine Learning, which has provided disruptive performance
                gains in several fields. Apart from undeniable advances in methodology, these gains are often attributed
                to massive amounts of training data and computing power, which led to breakthroughs in speech
                recognition, computer vision and language processing. Extending these advances to robotics, planning and
                control has proven to be difficult, as these applications often require learning from interactions
                instead of static data. They also currently suffer from low sample efficiency, often requiring billions
                of interactions [1], which makes learning in real-time from physical interactions with real robots
                intractable.
            </p>
        </div>

    </div>

    <div class="row">
        <div class="twelve columns" style="margin-top: 8%;position: relative;height: 130px">
            <img src="" height="128" width="128" id="imgr" style="position: absolute">
            <img src="" height="128" width="128" id="depthr" style="position: absolute;left:130px; ">
            <img src="" height="128" width="128" id="imgb" style="position: absolute;right: 0">
            <img src="" height="128" width="128" id="depthb" style="position: absolute;right: 130px">


            <div style="position: absolute;left:470px; top: 65px">
                <label for="trajsel">Trajectory</label>
                <select class="" id="trajsel">
                    <option value="0">0</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                </select>
            </div>

            <div style="position: absolute;left:570px; top: 65px">
                <label for="noisel">Noise</label>
                <select class="" id="noisel">
                    <option value="gaussian">Gaussian</option>
                    <option value="edge">Edge-Enhancing</option>
                    <option value="brightness">Brightness</option>
                    <option value="pepper">Pepper</option>
                    <option value="sharpen">Sharpen</option>
                    <option value="trans">Transforms</option>
                    <option value="white">White balance</option>

                </select>
            </div>


            <img class="play" style="width: 29px;position: absolute;left: 290px;top:40px" src="assets/play-sign.svg">
            <input id="timeline" type="range" min="0" max="58" step="1" value="0"
                   style="position: absolute;left: 335px;top:52px;width: 450px">
            <p id="timelineTxt" style="position: absolute;left: 793px;top:43px"> 0 </p>
        </div>

    </div>


    <div class="row">
        <div class="six columns" style="margin-top: 1%">
            <svg id="proj" style="width: 100%;height: 530px;border: #555555 solid 1px"></svg>
        </div>
        <div class="six columns" style="margin-top: 1%">
            <svg id="loc" style="width: 100%;height: 530px;border: #555555 solid 1px"></svg>
        </div>
        <div class="twelve columns" style="height: 140px" id="imband"></div>
    </div>


    <div class="row" style="text-align: center">
        <div class="twelve columns" style="margin-top: 2%;display: inline-block">
            <div style=" text-align: left;margin-bottom: 50px">
                <h5>Authors</h5>
                <p><a href="https://theo-jaunet.github.io/">Théo Jaunet</a> (<a href="https://twitter.com/jaunet_theo">@jaunet_theo</a>),
                    <a href="http://romain.vuillemot.net/">Romain
                        Vuillemot</a> (<a href="https://twitter.com/romsson">@romsson</a>) and <a
                            href="https://perso.liris.cnrs.fr/christian.wolf/">Christian Wolf </a>(<a
                            href="https://twitter.com/chriswolfvision">@chriswolfvision</a>), at LIRIS lab Lyon -
                    France.
                </p>
                This work takes place in Théo jaunet's Ph.D. which is supported by a French Ministry Fellowship and the
                <a
                        href="https://projet.liris.cnrs.fr/mi2/"> M2I project</a>,
            </div>

        </div>
    </div>

</div>

<script>
    // const data = fakedata(200);
    let dato;
    let idSel = [];
    let elements
    let elements2

    let curStep = 0;
    let curTraj = "0";
    let curNoise = "gaussian";

    let pl = false;
    let timer = null;

    const proj = d3.select("#proj");
    const loc = d3.select("#loc");


    let colscale = d3.scaleLinear().domain([0, 20]).range(['green', 'red'])


    $("#timeline").on("input", function () {


        let step = $(this).val();

        let ell = dato[step]

        curStep = parseInt(step);


        $("#imgr").attr("src", 'data:image/jpeg;base64,' + ell.imgR)
        $("#depthr").attr("src", 'data:image/jpeg;base64,' + ell.depthR)

        $("#imgb").attr("src", 'data:image/jpeg;base64,' + ell.imgB)
        $("#depthb").attr("src", 'data:image/jpeg;base64,' + ell.depthB)

        $("#timelineTxt").html(step)

        update_time()

    });


    $('.play').on('click', function () {


        pl = !pl;
        if (pl) {
            $(this).attr('src', 'assets/round-pause-button.svg');

            timer = setInterval(step, 115);
            step()
        } else {
            $(this).attr('src', 'assets/play-sign.svg');
            clearInterval(timer);
            timer = null
        }
    });


    function update_time() {

        let tbar = $('#timeline');

        let val = (tbar.val() - tbar.attr('min')) / (tbar.attr('max') - tbar.attr('min'));

        tbar.css('background-image',
            '-webkit-gradient(linear, left top, right top, '
            + 'color-stop(' + val + ', #233E34), '
            + 'color-stop(' + val + ', #C5C5C5)'
            + ')'
        );
    }

    function step() {

        curStep += 1;
        let ell = dato[curStep];


        if (ell) {
            $("#imgr").attr("src", 'data:image/jpeg;base64,' + ell.imgR)
            $("#depthr").attr("src", 'data:image/jpeg;base64,' + ell.depthR)

            $("#imgb").attr("src", 'data:image/jpeg;base64,' + ell.imgB)
            $("#depthb").attr("src", 'data:image/jpeg;base64,' + ell.depthB)

            $("#timelineTxt").html(curStep)

            $("#timeline").val(curStep);

            update_time()


        } else {
            pl = false;
            $('.play ').attr('src', 'assets/play-sign.svg');
            curStep = 0;
            clearInterval(timer);
            timer = null
        }

    }


    const cirhov = proj.append("circle")
        .attr("id", "projHov")
        .attr("stroke", "#333333")
        .attr("stroke-width", "1")
        .attr("fill", "none")
        .attr("r", "24");

    const cirhov2 = loc.append("circle")
        .attr("id", "locHov")
        .attr("stroke", "#333333")
        .attr("stroke-width", "1")
        .attr("fill", "none")
        .attr("r", "24");


    $("#trajsel").on("change", function () {

        console.log($("#trajsel").val());

        curTraj = $("#trajsel").val();

        getData("datasets/traj" + curTraj + "/" + curTraj + "_" + curNoise + ".json").then(function () {

            proj.selectAll("path").remove();
            proj.selectAll("line").remove();
            loc.selectAll("path").remove();
            loc.selectAll("line").remove();

            dato.sort((a, b) => {

                if (a.id > b.id) {
                    return 1
                } else {
                    return -1
                }

            });
            console.log(dato);

            let elem = dato.filter(d => d.id === 0)[0];

            console.log(elem);

            $("#imgr").attr("src", 'data:image/jpeg;base64,' + elem.imgR)
            $("#depthr").attr("src", 'data:image/jpeg;base64,' + elem.depthR)

            $("#imgb").attr("src", 'data:image/jpeg;base64,' + elem.imgB)
            $("#depthb").attr("src", 'data:image/jpeg;base64,' + elem.depthB)


            drawPoints(dato, proj);
            drawElements(dato, d3.select("#loc"));

            elements = proj.selectAll(".projDot");
            elements2 = loc.selectAll(".locDot");

            $("#timeline").attr("max", dato.length - 1)
        });

    })


    $("#noisel").on("change", function () {

        // console.log($("#trajsel").val());

        curNoise = $("#noisel").val();

        getData("datasets/traj" + curTraj + "/" + curTraj + "_" + curNoise + ".json").then(function () {


            proj.selectAll("path").remove();
            proj.selectAll("line").remove();
            loc.selectAll("path").remove();
            loc.selectAll("line").remove();

            dato.sort((a, b) => {

                if (a.id > b.id) {
                    return 1
                } else {
                    return -1
                }

            });
            console.log(dato);

            let elem = dato.filter(d => d.id === 0)[0];

            console.log(elem);

            $("#imgr").attr("src", 'data:image/jpeg;base64,' + elem.imgR)
            $("#depthr").attr("src", 'data:image/jpeg;base64,' + elem.depthR)

            $("#imgb").attr("src", 'data:image/jpeg;base64,' + elem.imgB)
            $("#depthb").attr("src", 'data:image/jpeg;base64,' + elem.depthB)


            drawPoints(dato, proj);
            drawElements(dato, d3.select("#loc"));

            elements = proj.selectAll(".projDot");
            elements2 = loc.selectAll(".locDot");
            $("#timeline").attr("max", dato.length - 1)

        });

    })


    getData("datasets/traj" + curTraj + "/" + curTraj + "_" + curNoise + ".json").then(function () {

        proj.selectAll("path").remove();
        proj.selectAll("line").remove();
        loc.selectAll("path").remove();
        loc.selectAll("line").remove();
        $("#timeline").attr("max", dato.length)
        dato.sort((a, b) => {

            if (a.id > b.id) {
                return 1
            } else {
                return -1
            }

        });
        console.log(dato);

        let elem = dato.filter(d => d.id === 0)[0];

        console.log(elem);

        $("#imgr").attr("src", 'data:image/jpeg;base64,' + elem.imgR)
        $("#depthr").attr("src", 'data:image/jpeg;base64,' + elem.depthR)

        $("#imgb").attr("src", 'data:image/jpeg;base64,' + elem.imgB)
        $("#depthb").attr("src", 'data:image/jpeg;base64,' + elem.depthB)


        drawPoints(dato, proj);
        drawElements(dato, d3.select("#loc"));

        elements = proj.selectAll(".projDot");
        elements2 = loc.selectAll(".locDot");


    });

    // debugInit();


    function debugInit() {
        loadmap(loc, 'assets/images/map.jpg');
        drawPoints(data, proj);
        drawElements(data, d3.select("#loc"));
    }

    async function getData(url) {
        dato = await d3.json(url).then(d => {
            return JSON.parse(d.replace(/'/g, '"'))
        });
    }


    function loadmap(svg, map) {

        svg.append('image')
            .attr('xlink:href', map)
            .attr('x', -40)
            .attr('y', -15)
            .style('width', '110%').moveToBack()
    }


    proj.on('mousemove', function () {

        const coords = d3.mouse(proj.node());
        cirhov.transition().duration(25).attr("transform", "translate(" + coords[0] + ", " + coords[1] + ")")


        let inside = elements.filter(d => {
            return euclidian_dist([proj_xscacle(d.px1), proj_yscacle(d.py1)], coords) < 25
        });


        // console.log(idSel);

        inside.transition().duration(5).attr("fill", "purple");

        // console.log(inside);


        let inside2 = elements2.filter(d => {
            return euclidian_dist([proj_xscacle(d.px1), proj_yscacle(d.py1)], coords) < 25
        });

        // console.log(elements2);
        inside2.transition().duration(5).attr("fill", "purple");

        elements2.filter(d => {
            return euclidian_dist([proj_xscacle(d.px1), proj_yscacle(d.py1)], coords) > 24
        }).transition().duration(5).attr("fill", (d) => colscale(euclidian_dist([loc_xscacle(d.lx1), loc_yscacle(d.ly1)], [loc_xscacle(d.lx2), loc_yscacle(d.ly2)])))


        elements.filter(d => {
            return euclidian_dist([proj_xscacle(d.px1), proj_yscacle(d.py1)], coords) > 24
        }).transition().attr("fill", (d) => colscale(euclidian_dist([proj_xscacle(d.px1), proj_yscacle(d.py1)], [proj_xscacle(d.px2), proj_yscacle(d.py2)])))


        elements.each((d) => {

            // console.log(d);
            if (euclidian_dist([proj_xscacle(d.px1), proj_yscacle(d.py1)], coords) < 25) {

                if (!idSel.includes(d.id)) {
                    const orr = -90 + (Math.atan2(proj_yscacle(d.py1) - proj_yscacle(d.py2), proj_xscacle(d.px1) - proj_xscacle(d.px2)) * (180 / Math.PI));
                    const orr2 = -90 + (Math.atan2(loc_yscacle(d.ly1) - loc_yscacle(d.ly2), loc_xscacle(d.lx1) - loc_xscacle(d.lx2)) * (180 / Math.PI));

                    proj.append("path")
                        .attr("class", "tbrm")
                        // .style("transform-origin", "50% 50%")
                        .attr("num", d.id)
                        .attr("fill", "steelblue")
                        .attr("d", "m 20 20 a -6 6 7 0 1 14 0 l -7 23 l -7 -23")
                        .attr("transform", "rotate(" + (orr) + " " + (proj_xscacle(d.px2) - 2) + " " + (proj_yscacle(d.py2) - 2) + ") translate(" + (proj_xscacle(d.px2) - 16) + "," + (proj_yscacle(d.py2) - 16) + ")  scale(0.5) ")

                    loc.append("path")
                        .attr("class", "tbrm")
                        .attr("num", d.id)
                        .attr("fill", "steelblue")
                        .attr("d", "m 20 20 a -6 6 7 0 1 14 0 l -7 23 l -7 -23")
                        .attr("transform", "rotate(" + (orr2) + " " + (loc_xscacle(d.lx2) - 2) + " " + (loc_yscacle(d.ly2) - 2) + ") translate(" + (loc_xscacle(d.lx2) - 16) + "," + (loc_yscacle(d.ly2) - 16) + ")  scale(0.5) ")
                    // .attr("transform", "rotate(180 64 62) translate(50 50) scale(0.5)")

                    idSel.push(d.id)

                    let tpath = proj.append("line")
                        .attr("class", "tbrm")
                        .attr("num", d.id)
                        .attr("x1", proj_xscacle(d.px1))
                        .attr("y1", proj_yscacle(d.py1))
                        .attr("x2", proj_xscacle(d.px2))
                        .attr("y2", proj_yscacle(d.py2))
                        .attr('stroke', 'steelblue')
                        .style('stroke-width', '3px')

                    let totalLength = tpath.node().getTotalLength();

                    tpath.attr("stroke-dasharray", totalLength + " " + totalLength)
                        .attr("stroke-dashoffset", totalLength)
                        .transition()
                        .duration(250)
                        .attr("stroke-dashoffset", 0);


                    let tpath2 = loc.append("line")
                        .attr("class", "tbrm")
                        .attr("num", d.id)
                        .attr("x1", loc_xscacle(d.lx1))
                        .attr("y1", loc_yscacle(d.ly1))
                        .attr("x2", loc_xscacle(d.lx2))
                        .attr("y2", loc_yscacle(d.ly2))
                        .attr('stroke', 'steelblue')
                        .style('stroke-width', '3px')

                    let totalLength2 = tpath2.node().getTotalLength();

                    tpath2.attr("stroke-dasharray", totalLength2 + " " + totalLength2)
                        .attr("stroke-dashoffset", totalLength2)
                        .transition()
                        .duration(250)
                        .attr("stroke-dashoffset", 0)

                }
            } else {
                let tid = idSel.indexOf(d.id);
                if (tid) {
                    idSel.splice(tid)
                    d3.selectAll('.tbrm[num="' + d.id + '"]').remove()

                }

            }
        })


    });


    loc.on('mousemove', function () {

        const coords = d3.mouse(loc.node());
        cirhov2.transition().duration(25).attr("transform", "translate(" + coords[0] + ", " + coords[1] + ")")


        let inside = elements2.filter(d => {
            return euclidian_dist([loc_xscacle(d.lx1), loc_yscacle(d.ly1)], coords) < 25
        });

        inside.transition().duration(5).attr("fill", "purple");

        // console.log(inside);


        let inside2 = elements.filter(d => {
            return euclidian_dist([loc_xscacle(d.lx1), loc_yscacle(d.ly1)], coords) < 25
        });

        // console.log(elements2);
        inside2.transition().duration(5).attr("fill", "purple");

        elements2.filter(d => {
            return euclidian_dist([loc_xscacle(d.lx1), loc_yscacle(d.ly1)], coords) > 24
        }).transition().duration(5).attr("fill", (d) => colscale(euclidian_dist([loc_xscacle(d.lx1), loc_yscacle(d.ly1)], [loc_xscacle(d.lx2), loc_yscacle(d.ly2)])))


        elements.filter(d => {
            return euclidian_dist([loc_xscacle(d.px1), loc_yscacle(d.py1)], coords) > 24
        }).transition().duration(5).attr("fill", (d) => colscale(euclidian_dist([proj_xscacle(d.px1), proj_yscacle(d.py1)], [proj_xscacle(d.px2), proj_yscacle(d.py2)])))


        elements.each((d) => {

            // console.log(d);
            if (euclidian_dist([loc_xscacle(d.lx1), loc_yscacle(d.ly1)], coords) < 25) {

                if (!idSel.includes(d.id)) {
                    const orr = -90 + (Math.atan2(proj_yscacle(d.py1) - proj_yscacle(d.py2), proj_xscacle(d.px1) - proj_xscacle(d.px2)) * (180 / Math.PI));
                    const orr2 = -90 + (Math.atan2(loc_yscacle(d.ly1) - loc_yscacle(d.ly2), loc_xscacle(d.lx1) - loc_xscacle(d.lx2)) * (180 / Math.PI));

                    proj.append("path")
                        .attr("class", "tbrm")
                        // .style("transform-origin", "50% 50%")
                        .attr("num", d.id)
                        .attr("fill", "steelblue")
                        .attr("d", "m 20 20 a -6 6 7 0 1 14 0 l -7 23 l -7 -23")
                        .attr("transform", "rotate(" + (orr) + " " + (proj_xscacle(d.px2) - 2) + " " + (proj_yscacle(d.py2) - 2) + ") translate(" + (proj_xscacle(d.px2) - 16) + "," + (proj_yscacle(d.py2) - 16) + ")  scale(0.5) ")

                    loc.append("path")
                        .attr("class", "tbrm")
                        .attr("num", d.id)
                        .attr("fill", "steelblue")
                        .attr("d", "m 20 20 a -6 6 7 0 1 14 0 l -7 23 l -7 -23")
                        .attr("transform", "rotate(" + (orr2) + " " + (loc_xscacle(d.lx2) - 2) + " " + (loc_yscacle(d.ly2) - 2) + ") translate(" + (loc_xscacle(d.lx2) - 16) + "," + (loc_yscacle(d.ly2) - 16) + ")  scale(0.5) ")
                    // .attr("transform", "rotate(180 64 62) translate(50 50) scale(0.5)")

                    idSel.push(d.id)

                    let tpath = proj.append("line")
                        .attr("class", "tbrm")
                        .attr("num", d.id)
                        .attr("x1", proj_xscacle(d.px1))
                        .attr("y1", proj_yscacle(d.py1))
                        .attr("x2", proj_xscacle(d.px2))
                        .attr("y2", proj_yscacle(d.py2))
                        .attr('stroke', 'steelblue')
                        .style('stroke-width', '3px')

                    let totalLength = tpath.node().getTotalLength();

                    tpath.attr("stroke-dasharray", totalLength + " " + totalLength)
                        .attr("stroke-dashoffset", totalLength)
                        .transition()
                        .duration(250)
                        .attr("stroke-dashoffset", 0);


                    let tpath2 = loc.append("line")
                        .attr("class", "tbrm")
                        .attr("num", d.id)
                        .attr("x1", loc_xscacle(d.lx1))
                        .attr("y1", loc_yscacle(d.ly1))
                        .attr("x2", loc_xscacle(d.lx2))
                        .attr("y2", loc_yscacle(d.ly2))
                        .attr('stroke', 'steelblue')
                        .style('stroke-width', '3px')

                    let totalLength2 = tpath2.node().getTotalLength();

                    tpath2.attr("stroke-dasharray", totalLength2 + " " + totalLength2)
                        .attr("stroke-dashoffset", totalLength2)
                        .transition()
                        .duration(250)
                        .attr("stroke-dashoffset", 0)

                }
            } else {
                let tid = idSel.indexOf(d.id);
                if (tid) {
                    idSel.splice(tid)
                    d3.selectAll('.tbrm[num="' + d.id + '"]').remove()

                }

            }
        })


    });


    // $("#proj").on("mousemove", function (e) {
    //
    //     // const coords = d3.mouse(this)
    //
    //     console.log(d3.event.pageX);
    //     // proj
    //
    //
    // })


</script>


</body>
</html>
